<div id="tab-manpower" class="tab-content hidden">
    <div class="card">
        <h3><i class="fas fa-user-edit"></i> Crew Management</h3>
        <p style="font-size:0.7rem; color:var(--primary); margin-bottom:10px;">TIP: Click Edit in the table to modify existing staff.</p>
        <div class="grid-inputs">
            <div><label>Name (Primary Key)</label><input type="text" id="mName" placeholder="Worker Name"></div>
            <div><label>Project Assignment</label><select id="mAssign"></select></div>
            <div><label>Current Status</label>
                <select id="mStatus">
                    <option value="On-Site">On-Site</option>
                    <option value="Standby">Standby / Office</option>
                    <option value="Medical Leave">Medical Leave (MC)</option>
                    <option value="Annual Leave">Annual Leave</option>
                </select>
            </div>
        </div>
        <button onclick="saveManpower()" class="btn-main" id="btnSaveMan">Sync Crew Data</button>
    </div>
    <div class="card">
        <table id="manTable">
            <thead><tr><th>Name</th><th>Status</th><th>Assignment</th><th style="text-align:right">Actions</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script type="module">
    // ... (Your Firebase Imports stay the same) ...

    // --- NEW: EDIT FUNCTIONS ---
    
    // Pulls data back into the form for editing
    window.editManpower = (name, status, assign) => {
        document.getElementById('mName').value = name;
        document.getElementById('mStatus').value = status;
        document.getElementById('mAssign').value = assign;
        
        // Visual feedback
        document.getElementById('btnSaveMan').style.background = "var(--accent)";
        document.getElementById('btnSaveMan').innerText = "Update Record";
        document.getElementById('mName').scrollIntoView({behavior: "smooth"});
    };

    window.editProject = (name, client, loc, val, due, status, desc) => {
        document.getElementById('pName').value = name;
        document.getElementById('pClient').value = client;
        document.getElementById('pLoc').value = loc;
        document.getElementById('pVal').value = val;
        document.getElementById('pDue').value = due;
        document.getElementById('pStatus').value = status;
        document.getElementById('pDesc').value = desc;
        
        document.getElementById('pName').scrollIntoView({behavior: "smooth"});
        alert("Editing: " + name);
    };

    // --- UPDATED STREAM LISTENERS TO INCLUDE EDIT BUTTONS ---

    onSnapshot(collection(db, "manpower"), snap => {
        const tbody = document.querySelector('#manTable tbody');
        tbody.innerHTML = '';
        snap.forEach(d => {
            const m = d.data();
            const sClass = m.status === 'On-Site' ? 'status-onsite' : (m.status.includes('Leave') ? 'status-leave' : 'status-standby');
            
            // Note the new "Edit" button that passes the data into the edit function
            tbody.innerHTML += `<tr>
                <td><b>${m.name}</b></td>
                <td><span class="status-pill ${sClass}">${m.status}</span></td>
                <td>${m.assignedTo}</td>
                <td style="text-align:right">
                    <button class="btn-edit" onclick="editManpower('${m.name}', '${m.status}', '${m.assignedTo}')" style="background:#2d3142; color:var(--primary); border:1px solid var(--primary); padding:4px 8px; border-radius:4px; cursor:pointer; margin-right:5px;">Edit</button>
                    <button class="btn-del" onclick="window.kill('manpower','${d.id}')" style="background:none; border:1px solid #e74c3c; color:#e74c3c; padding:4px 8px; border-radius:4px; cursor:pointer;">Delete</button>
                </td>
            </tr>`;
        });
    });

    onSnapshot(collection(db, "projects"), snap => {
        const tbody = document.querySelector('#projTable tbody');
        tbody.innerHTML = '';
        snap.forEach(d => {
            const p = d.data();
            tbody.innerHTML += `<tr>
                <td><b>${p.name}</b><br><small>${p.client}</small></td>
                <td>${p.loc}</td>
                <td>${p.value}</td>
                <td>${p.status}</td>
                <td style="text-align:right">
                    <button onclick="editProject('${p.name}','${p.client}','${p.loc}','${p.value}','${p.due}','${p.status}','${p.desc?.replace(/'/g, "\\'")}')" style="background:#2d3142; color:var(--primary); border:1px solid var(--primary); padding:4px 8px; border-radius:4px; cursor:pointer; margin-right:5px;">Edit</button>
                    <button onclick="window.kill('projects','${d.id}')" style="background:none; border:1px solid #e74c3c; color:#e74c3c; padding:4px 8px; border-radius:4px; cursor:pointer;">X</button>
                </td>
            </tr>`;
        });
    });

    // Reset buttons back to original state after saving
    const resetFormUI = () => {
        const btn = document.getElementById('btnSaveMan');
        if(btn) {
            btn.style.background = "var(--primary-dark)";
            btn.innerText = "Sync Crew Data";
        }
    }

    // Wrap your existing save functions to call resetFormUI() at the end.
</script>
