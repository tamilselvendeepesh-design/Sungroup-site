<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, collection, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCkND2Ip7G09rELaU-S9c0LXk1ffrFSc4g",
        authDomain: "sungroup-crm.firebaseapp.com",
        projectId: "sungroup-crm"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Track if we are editing
    let editMode = { type: null, id: null };

    onAuthStateChanged(auth, user => { 
        document.getElementById('auth-gate').style.display = user ? 'none' : 'flex'; 
    });

    document.getElementById('loginBtn').onclick = () => {
        signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('pass').value)
        .catch(err => document.getElementById('auth-error').innerText = err.message);
    };

    document.getElementById('logoutBtn').onclick = () => signOut(auth);

    // --- NEW: LOAD FOR EDITING ---
    window.prepEdit = (type, id, currentData) => {
        editMode = { type, id };
        const btn = type === 'projects' ? document.querySelector('#tab-projects .btn-main') : document.querySelector('#tab-manpower .btn-main');
        btn.innerText = "Update Record (Save Changes)";
        btn.style.background = "var(--success)";

        if (type === 'projects') {
            document.getElementById('pName').value = currentData.name;
            document.getElementById('pName').disabled = true; // Don't change name (it's the ID)
            document.getElementById('pClient').value = currentData.client;
            document.getElementById('pLoc').value = currentData.loc;
            document.getElementById('pVal').value = currentData.value;
            document.getElementById('pDue').value = currentData.due;
            document.getElementById('pStatus').value = currentData.status;
        } else {
            document.getElementById('mName').value = currentData.name;
            document.getElementById('mName').disabled = true;
            document.getElementById('mAssign').value = currentData.assignedTo;
            document.getElementById('mStatus').value = currentData.status;
        }
        window.scrollTo(0,0);
    };

    // --- SAVE / UPDATE DATA ---
    window.saveProject = async () => {
        const n = document.getElementById('pName').value; if(!n) return;
        
        await setDoc(doc(db, "projects", n), { 
            name: n, 
            client: document.getElementById('pClient').value, 
            loc: document.getElementById('pLoc').value, 
            value: parseFloat(document.getElementById('pVal').value)||0, 
            due: document.getElementById('pDue').value, 
            status: document.getElementById('pStatus').value,
            lastUpdated: Date.now() // Good for sorting later
        });

        // Reset Form
        ["pName", "pClient", "pLoc", "pVal", "pDue"].forEach(i => document.getElementById(i).value = '');
        document.getElementById('pName').disabled = false;
        const btn = document.querySelector('#tab-projects .btn-main');
        btn.innerText = "Sync Project Data";
        btn.style.background = "var(--primary-dark)";
        editMode = { type: null, id: null };
    };

    window.saveManpower = async () => {
        const n = document.getElementById('mName').value; if(!n) return;
        await setDoc(doc(db, "manpower", n), { 
            name: n, 
            status: document.getElementById('mStatus').value, 
            assignedTo: document.getElementById('mAssign').value 
        });
        document.getElementById('mName').value = '';
        document.getElementById('mName').disabled = false;
        const btn = document.querySelector('#tab-manpower .btn-main');
        btn.innerText = "Update Staff Status";
        btn.style.background = "var(--accent)";
        editMode = { type: null, id: null };
    };

    // --- SNAPSHOTS (Added Edit Buttons to rows) ---
    onSnapshot(collection(db, "projects"), snap => {
        const tbody = document.querySelector('#projTable tbody');
        tbody.innerHTML = '';
        snap.forEach(d => {
            const p = d.data();
            const dataStr = JSON.stringify(p).replace(/"/g, '&quot;');
            tbody.innerHTML += `<tr>
                <td><b>${p.name}</b></td>
                <td>${p.client}</td>
                <td>$${p.value}</td>
                <td>${p.status}</td>
                <td>
                    <button class="btn-edit" onclick="window.prepEdit('projects','${d.id}', ${dataStr})"><i class="fas fa-edit"></i></button>
                    <button class="btn-del" onclick="window.kill('projects','${d.id}')">X</button>
                </td>
            </tr>`;
        });
    });

    onSnapshot(collection(db, "manpower"), snap => {
        const tbody = document.querySelector('#manTable tbody');
        tbody.innerHTML = '';
        snap.forEach(d => {
            const m = d.data();
            const dataStr = JSON.stringify(m).replace(/"/g, '&quot;');
            tbody.innerHTML += `<tr>
                <td>${m.name}</td>
                <td><span class="status-pill ${m.status==='On-Site'?'status-onsite':'status-leave'}">${m.status}</span></td>
                <td>${m.assignedTo}</td>
                <td>
                    <button class="btn-edit" onclick="window.prepEdit('manpower','${d.id}', ${dataStr})"><i class="fas fa-edit"></i></button>
                    <button class="btn-del" onclick="window.kill('manpower','${d.id}')">X</button>
                </td>
            </tr>`;
        });
    });

    // Keep your other listeners (PO, Clients, etc.) and window.kill as they were.
    window.kill = async (coll, id) => { if(confirm("Delete permanently?")) await deleteDoc(doc(db, coll, id)); };
    window.showTab = (id) => {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById('tab-'+id).classList.remove('hidden');
    };
</script>
