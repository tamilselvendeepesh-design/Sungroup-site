<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sungroup ERP | Admin Suite</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <style>
        :root { --primary: #1e73be; --success: #27ae60; --danger: #e74c3c; --warning: #f39c12; --dark: #2c3e50; --bg: #f0f2f5; --sidebar-w: 260px; }
        body { background: var(--bg); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; color: var(--dark); display: flex; }
        
        #login-box { position: fixed; inset: 0; background: var(--dark); display: flex; justify-content: center; align-items: center; z-index: 10000; }
        .login-card { background: white; padding: 40px; border-radius: 15px; width: 340px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .hidden { display: none !important; }

        #dashboard { display: none; width: 100%; min-height: 100vh; }
        .sidebar { width: var(--sidebar-w); background: var(--dark); color: white; padding: 20px; flex-shrink: 0; height: 100vh; position: sticky; top: 0; display: flex; flex-direction: column; box-sizing: border-box; }
        .sidebar-logo { width: 140px; margin-bottom: 30px; align-self: center; filter: brightness(0) invert(1); }
        .main-content { flex-grow: 1; padding: 30px; background: var(--bg); overflow-y: auto; width: calc(100% - var(--sidebar-w)); }

        .nav-btn { width: 100%; text-align: left; padding: 12px; margin: 4px 0; background: none; border: none; color: #bdc3c7; cursor: pointer; border-radius: 6px; font-size: 0.95rem; }
        .nav-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .nav-btn.active { background: var(--primary); color: white; font-weight: bold; }
        
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        input, select, textarea { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .btn { padding: 10px 18px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .btn-save { background: var(--success); color: white; width: 100%; margin-top: 10px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; table-layout: fixed; }
        th { text-align: left; background: #f8f9fa; padding: 12px; border-bottom: 2px solid #eee; font-size: 0.8rem; }
        td { padding: 12px; border-bottom: 1px solid #f0f0f0; font-size: 0.85rem; word-wrap: break-word; }
        .action-btn { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.7rem; }
        .del { background: var(--danger); color: white; }
        .edit { background: var(--warning); color: white; margin-right: 4px; }
    </style>
</head>
<body>

    <div id="login-box">
        <div class="login-card">
            <img src="logo.png" style="width:160px;">
            <h3>Admin Portal</h3>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="pass" placeholder="Password">
            <button id="loginBtn" class="btn btn-save" style="background:var(--primary)">Login</button>
        </div>
    </div>

    <div id="dashboard">
        <div class="sidebar">
            <img src="logo.png" class="sidebar-logo">
            <button class="nav-btn active" onclick="showTab('projects')">üèóÔ∏è Projects</button>
            <button class="nav-btn" onclick="showTab('manpower')">üë∑ Manpower</button>
            <button class="nav-btn" onclick="showTab('clients')">ü§ù Clients</button>
            <button class="nav-btn" onclick="showTab('jobs')">üìÑ Applications</button>
            <button class="nav-btn" onclick="showTab('msgs')">üí¨ Inquiries</button>
            <button class="nav-btn" onclick="showTab('finance')">üìâ Notes</button>
            <button id="logoutBtn" class="nav-btn" style="margin-top:auto; color:var(--danger);">Sign Out</button>
        </div>

        <div class="main-content">
            <div id="tab-projects" class="tab-content">
                <div class="card">
                    <h3>Project Dispatcher</h3>
                    <div class="grid-4">
                        <input type="text" id="pName" placeholder="Project Name">
                        <select id="pClientSelect"><option value="">-- Client --</option></select>
                        <select id="pPay"><option>Unpaid</option><option>Partial</option><option>Paid</option></select>
                        <input type="date" id="pDeadline">
                    </div>
                    <div class="grid-4">
                        <input type="number" id="pProg" placeholder="Progress %">
                        <input type="text" id="pLoc" placeholder="Location Link">
                        <select id="pHse"><option>Standard</option><option>High Risk</option></select>
                        <button id="saveProjBtn" class="btn btn-save" style="margin:8px 0">Save Project</button>
                    </div>
                </div>
                <div class="card">
                    <table id="projTable">
                        <thead><tr><th>Project</th><th>Deadline</th><th>%</th><th>Status</th><th>Actions</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="tab-manpower" class="tab-content hidden">
                <div class="card">
                    <h3>Manpower Log</h3>
                    <div class="grid-4">
                        <select id="mProj"><option value="">-- Project --</option></select>
                        <input type="number" id="mCount" placeholder="Staff Count">
                        <input type="text" id="mLeader" placeholder="Supervisor">
                        <button id="saveManBtn" class="btn btn-save" style="margin:0">Log</button>
                    </div>
                </div>
                <div class="card"><table id="manTable"><thead><tr><th>Site</th><th>Staff</th><th>Lead</th><th>Action</th></tr></thead><tbody></tbody></table></div>
            </div>

            <div id="tab-clients" class="tab-content hidden">
                <div class="card">
                    <h3>Client CRM</h3>
                    <div class="grid-4">
                        <input type="text" id="cCompany" placeholder="Company">
                        <input type="text" id="cName" placeholder="PIC">
                        <input type="tel" id="cPhone" placeholder="Phone">
                        <button id="saveClientBtn" class="btn btn-save" style="margin:0">Add</button>
                    </div>
                </div>
                <div class="card"><table id="clientTable"><thead><tr><th>Company</th><th>PIC</th><th>Phone</th><th>Action</th></tr></thead><tbody></tbody></table></div>
            </div>

            <div id="tab-jobs" class="tab-content hidden">
                <div class="card">
                    <h3>Applications</h3>
                    <table id="jobTable">
                        <thead><tr><th>Name</th><th>Role</th><th>Date</th><th>Resume</th><th>Action</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="tab-msgs" class="tab-content hidden">
                <div class="card">
                    <h3>Contact Messages</h3>
                    <table id="msgTable">
                        <thead><tr><th>From</th><th>Subject</th><th>Message</th><th>Action</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="tab-finance" class="tab-content hidden">
                <div class="card">
                    <h3>Admin Notes</h3>
                    <textarea id="notes" rows="15" oninput="localStorage.setItem('sgNotes', this.value)"></textarea>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCkND2Ip7G09rELaU-S9c0LXk1ffrFSc4g",
            authDomain: "sungroup-crm.firebaseapp.com",
            projectId: "sungroup-crm",
            storageBucket: "sungroup-crm.firebasestorage.app",
            messagingSenderId: "982155471354",
            appId: "1:982155471354:web:c4b61192d247c9739edc43"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        onAuthStateChanged(auth, u => {
            document.getElementById('login-box').style.display = u ? 'none' : 'flex';
            document.getElementById('dashboard').style.display = u ? 'flex' : 'none';
            if(u && localStorage.getItem('sgNotes')) document.getElementById('notes').value = localStorage.getItem('sgNotes');
        });

        document.getElementById('loginBtn').onclick = () => {
            signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('pass').value).catch(e => alert(e.message));
        };
        document.getElementById('logoutBtn').onclick = () => signOut(auth);

        window.showTab = (id) => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-'+id).classList.remove('hidden');
            event.target.classList.add('active');
        };

        // SYNC LOGIC
        onSnapshot(collection(db, "projects"), snap => {
            const body = document.querySelector("#projTable tbody");
            const mSelect = document.getElementById('mProj');
            body.innerHTML = ''; mSelect.innerHTML = '<option value="">-- Project --</option>';
            snap.forEach(doc => {
                const p = doc.data();
                mSelect.innerHTML += `<option value="${p.projectName}">${p.projectName}</option>`;
                body.innerHTML += `<tr><td><b>${p.projectName}</b></td><td>${p.deadline || '-'}</td><td>${p.progress}%</td><td>${p.payment}</td>
                <td><button class="action-btn edit" onclick="editP('${p.projectName}','${p.progress}','${p.payment}','${p.deadline}')">‚úé</button>
                <button class="action-btn del" onclick="delD('projects','${p.projectName}')">X</button></td></tr>`;
            });
        });

        onSnapshot(collection(db, "clients"), snap => {
            const body = document.querySelector("#clientTable tbody");
            const pClient = document.getElementById('pClientSelect');
            body.innerHTML = ''; pClient.innerHTML = '<option value="">-- Client --</option>';
            snap.forEach(doc => {
                const c = doc.data();
                pClient.innerHTML += `<option value="${c.company}">${c.company}</option>`;
                body.innerHTML += `<tr><td>${c.company}</td><td>${c.contactPerson}</td><td>${c.phone}</td><td><button class="action-btn del" onclick="delD('clients','${c.company}')">X</button></td></tr>`;
            });
        });

        onSnapshot(collection(db, "applications"), snap => {
            const body = document.querySelector("#jobTable tbody");
            body.innerHTML = '';
            snap.forEach(doc => {
                const a = doc.data();
                body.innerHTML += `<tr><td><b>${a.name}</b></td><td>${a.role}</td><td>${new Date(a.appliedDate).toLocaleDateString()}</td><td><a href="${a.resume}" target="_blank">Link</a></td><td><button class="action-btn del" onclick="delD('applications','${a.email}')">X</button></td></tr>`;
            });
        });

        onSnapshot(collection(db, "inquiries"), snap => {
            const body = document.querySelector("#msgTable tbody");
            body.innerHTML = '';
            snap.forEach(doc => {
                const i = doc.data();
                body.innerHTML += `<tr><td><b>${i.name}</b><br>${i.email}</td><td>${i.subject}</td><td>${i.message}</td><td><button class="action-btn del" onclick="delD('inquiries','${doc.id}')">X</button></td></tr>`;
            });
        });

        onSnapshot(collection(db, "manpower"), snap => {
            const body = document.querySelector("#manTable tbody");
            body.innerHTML = '';
            snap.forEach(doc => {
                const m = doc.data();
                body.innerHTML += `<tr><td>${m.project}</td><td>${m.count}</td><td>${m.leader}</td><td><button class="action-btn del" onclick="delD('manpower','${m.project}')">X</button></td></tr>`;
            });
        });

        // SAVE LOGIC
        document.getElementById('saveProjBtn').onclick = async () => {
            const n = document.getElementById('pName').value;
            if(!n) return;
            await setDoc(doc(db, "projects", n), { projectName: n, clientName: document.getElementById('pClientSelect').value, progress: document.getElementById('pProg').value || 0, payment: document.getElementById('pPay').value, deadline: document.getElementById('pDeadline').value });
            alert("Updated");
        };

        document.getElementById('saveManBtn').onclick = async () => {
            const p = document.getElementById('mProj').value;
            await setDoc(doc(db, "manpower", p), { project: p, count: document.getElementById('mCount').value, leader: document.getElementById('mLeader').value });
        };

        document.getElementById('saveClientBtn').onclick = async () => {
            const co = document.getElementById('cCompany').value;
            await setDoc(doc(db, "clients", co), { company: co, contactPerson: document.getElementById('cName').value, phone: document.getElementById('cPhone').value });
        };

        window.delD = async (c, id) => { if(confirm('Delete?')) await deleteDoc(doc(db, c, id)); };
        window.editP = (n, pr, py, d) => { document.getElementById('pName').value = n; document.getElementById('pProg').value = pr; document.getElementById('pPay').value = py; document.getElementById('pDeadline').value = d; };
    </script>
</body>
</html>
