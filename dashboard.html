<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TITAN ERP | Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { 
            --primary: #00d2ff; --dark: #0a0c14; --surface: #161a27; --border: #2d3142; --text: #d5d6d7;
            --sidebar-w: 260px;
        }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--dark); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* Full Screen Security Loader */
        #gatekeeper { position: fixed; inset: 0; background: var(--dark); z-index: 100000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spin { width: 45px; height: 45px; border: 4px solid rgba(0, 210, 255, 0.1); border-top: 4px solid var(--primary); border-radius: 50%; animation: rot 1s linear infinite; }
        @keyframes rot { to { transform: rotate(360deg); } }

        /* UI Layout */
        .sidebar { width: var(--sidebar-w); background: var(--surface); border-right: 1px solid var(--border); padding: 25px; display: flex; flex-direction: column; }
        .nav-link { padding: 12px 15px; color: var(--text); text-decoration: none; border-radius: 8px; margin-bottom: 5px; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: 0.2s; }
        .nav-link:hover { background: #1e73be; color: white; }
        .viewport { flex: 1; padding: 40px; overflow-y: auto; background: radial-gradient(circle at 0% 0%, #161a27 0%, #0a0c14 100%); }
        .card { background: var(--surface); padding: 30px; border-radius: 15px; border: 1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .btn-logout { margin-top: auto; color: #ff4d4d; border: 1px solid #ff4d4d; text-align: center; padding: 10px; border-radius: 6px; cursor: pointer; transition: 0.3s; }
        .btn-logout:hover { background: #ff4d4d; color: white; }
    </style>
</head>
<body>

    <div id="gatekeeper">
        <div class="spin"></div>
        <p style="color: var(--primary); margin-top: 20px; font-weight: bold; letter-spacing: 2px;">VERIFYING ENCRYPTED SESSION</p>
    </div>

    <nav class="sidebar">
        <h2 style="color: var(--primary); margin-bottom: 30px;">TITAN ERP</h2>
        <div class="nav-link"><i class="fas fa-th-large"></i> Overview</div>
        <div class="nav-link"><i class="fas fa-ship"></i> Active Projects</div>
        <div class="nav-link"><i class="fas fa-hard-hat"></i> Site Personnel</div>
        <div id="logoutBtn" class="btn-logout">TERMINATE SESSION</div>
    </nav>

    <main class="viewport">
        <div class="card">
            <h1 style="margin-top:0;">Command Dashboard</h1>
            <p style="color:#888;">Authenticated as Root Administrator.</p>
            <hr style="border:0; border-top:1px solid var(--border); margin: 25px 0;">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div style="background:#0a0c14; padding:20px; border-radius:10px;">
                    <h3 style="color:var(--primary); margin-top:0;">System Health</h3>
                    <p style="font-size:0.8rem;">Encryption: AES-256<br>MFA Status: Active (+65 9185 4358)</p>
                </div>
                <div style="background:#0a0c14; padding:20px; border-radius:10px;">
                    <h3 style="color:#2ecc71; margin-top:0;">Live Feed</h3>
                    <p style="font-size:0.8rem;">Syncing with Firebase Firestore Real-time...</p>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCkND2Ip7G09rELaU-S9c0LXk1ffrFSc4g",
            authDomain: "sungroup-crm.firebaseapp.com",
            projectId: "sungroup-crm"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // --- THE SECURITY GATE ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Ensure email is verified and MFA is enrolled
                const factors = user.multiFactor?.enrolledFactors || [];
                if (user.emailVerified && factors.length > 0) {
                    // Success: Access granted
                    document.getElementById('gatekeeper').style.display = 'none';
                } else {
                    // Fail: Not verified or no MFA
                    window.location.href = 'admin.html';
                }
            } else {
                // Fail: No user logged in
                window.location.href = 'admin.html';
            }
        });

        document.getElementById('logoutBtn').onclick = () => {
            signOut(auth).then(() => {
                window.location.href = 'admin.html';
            });
        };
    </script>
</body>
</html>
