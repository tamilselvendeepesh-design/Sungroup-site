<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TITAN ERP | Dashboard</title>
    <style>
        body { background: #0a0c14; color: white; font-family: sans-serif; }
        #gatekeeper { position: fixed; inset: 0; background: #0a0c14; z-index: 999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .spin { width: 40px; height: 40px; border: 4px solid #1e73be; border-top-color: transparent; border-radius: 50%; animation: s 1s linear infinite; }
        @keyframes s { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="gatekeeper">
        <div class="spin"></div>
        <p id="msg">INITIALIZING SECURE SESSION...</p>
    </div>

    <div id="content" style="display:none; padding: 40px;">
        <h1 style="color:#00d2ff">DASHBOARD LOADED</h1>
        <p>Security Status: <b style="color:#2ecc71">VERIFIED</b></p>
        <button onclick="signOutNow()" style="padding:10px; cursor:pointer;">Logout</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyCkND2Ip7G09rELaU-S9c0LXk1ffrFSc4g", authDomain: "sungroup-crm.firebaseapp.com", projectId: "sungroup-crm" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        onAuthStateChanged(auth, async (user) => {
            const msg = document.getElementById('msg');
            
            if (user) {
                // Check MFA factors
                let factors = user.multiFactor?.enrolledFactors || [];
                
                // If factors are empty, try ONE hard reload from server
                if (factors.length === 0) {
                    msg.innerText = "SYNCING SECURITY PROFILE...";
                    await user.reload();
                    factors = auth.currentUser.multiFactor?.enrolledFactors || [];
                }

                if (factors.length > 0) {
                    document.getElementById('gatekeeper').style.display = 'none';
                    document.getElementById('content').style.display = 'block';
                } else {
                    msg.innerText = "ACCESS DENIED: MFA REQUIRED. REDIRECTING...";
                    setTimeout(() => { window.location.href = "admin.html"; }, 2000);
                }
            } else {
                window.location.href = "admin.html";
            }
        });

        window.signOutNow = () => signOut(auth).then(() => window.location.href = "admin.html");
    </script>
</body>
</html>
